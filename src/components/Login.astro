---
import { checkParams, hash, parseBody } from '../utils';
import { getProfile, isValidProfileAttribute, login, setDB } from '../api';

let err: Error | undefined;
if (Astro.request.method == 'POST') {
	setDB(Astro.locals.runtime?.env?.DB);

	try {
		const body = await parseBody<{ email: string; password: string }>(Astro.request);
		if (!isValidProfileAttribute('email', body.email)) throw 'You must enter a valid email.';

		checkParams(body, 'email', 'password');

		const profile = await getProfile('email', body.email);

		if (!profile) {
			throw 'Profile does not exist';
		}

		if (profile.is_disabled) {
			throw 'Profile is disabled';
		}

		if (profile.password != hash(body.password)) {
			throw 'Incorrect password';
		}

		const token = await login(profile.id);
		Astro.cookies.set('token', token, { expires: new Date(Date.now() + 3600_000 * 24 * 28) });
		return Astro.redirect('/');
	} catch (e) {
		err = e;
	}
}

import '../styles/forms.css';
---

<form method="post">
	<h1>Login</h1>
	{err && <div class="error">{err}</div>}
	<label for="email">Email</label>
	<input name="email" type="email" autocomplete="email" />
	<label for="password">Password</label>
	<input name="password" type="password" autocomplete="current-password" />
	<button>Login</button>
</form>
