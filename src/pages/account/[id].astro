---
import { getAccount, getTransactions, setDB } from '../../api';
import TransactionLI from '../../components/TransactionLI.astro';
import Main from '../../layouts/Main.astro';
import { currentUser } from '../../utils';

setDB(Astro.locals.runtime?.env?.DB);

const profile = await currentUser(Astro.cookies);

if (!profile) {
	return Astro.redirect('/login');
}

const account = Astro.params.id ? await getAccount(Astro.params.id) : null;

const transactions = account && (await getTransactions(account.id));

import '../../styles/transaction-li.css';
---

<style>
	.header {
		font-weight: bold;
		border: none;
	}
</style>
<Main title="Account">
	{!account && <div class="error">That account doesn't exist</div>}
	{
		account && (
			<div>
				<p>Account name: {account.name}</p>
				<p>Account type: {account.type}</p>
				<p>Account ID: {account.id.slice(0, 10)}...</p>
				<h4>Transactions</h4>
				{!transactions ? (
					<p>
						<em>Couldn't fetch your transactions.</em>
					</p>
				) : (
					<ul>
						<li class="header">
							<p class="account">Account</p>
							<p class="amount">Amount</p>
							<p class="timestamp">Time</p>
							<p class="Details">Details</p>
						</li>
						{transactions.map(tx => (
							<TransactionLI transaction={tx} account={account.id} />
						))}
					</ul>
				)}
			</div>
		)
	}
</Main>
